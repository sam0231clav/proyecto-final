<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ofertas | Empleo CE</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header class="header">
    <div class="container">
      <h1>Empleo Corredor Ecológico</h1>
      <button class="btn-logout" onclick="logout()">Cerrar Sesión</button>
    </div>
  </header>

  <main class="container">
    <h2>Oportunidades Laborales</h2>
    <div id="lista-ofertas">Cargando...</div>
  </main>

  <script>
    const token = localStorage.getItem('token');
    if (!token) window.location.href = 'index.html';

    async function cargarOfertas() {
      const res = await fetch('/ofertas', { headers: { 'Authorization': `Bearer ${token}` } });
      const ofertas = await res.json();
      const lista = document.getElementById('lista-ofertas');

      if (ofertas.length === 0) {
        lista.innerHTML = '<p>No hay ofertas disponibles.</p>';
        return;
      }

      lista.innerHTML = ofertas.map(o => `
        <div class="oferta-card">
          <h4>${o.titulo}</h4>
          <p><strong>${o.empresa}</strong> - ${o.municipio}</p>
          <p>${o.descripcion}</p>
          <small>Publicado: ${new Date(o.fecha).toLocaleDateString()}</small>
          ${o.estado_postulacion ? 
            `<p style="margin-top:10px; font-weight:bold; color:${o.estado_postulacion==='aceptada'?'green':o.estado_postulacion==='rechazada'?'red':'orange'}">
              Estado: ${o.estado_postulacion.toUpperCase()}
            </p>` : 
            `<button class="btn-postular" onclick="postularme(${o.id})">Postularme</button>`
          }
        </div>
      `).join('');
    }

    async function postularme(id) {
      if (!confirm('¿Postularte a esta oferta?')) return;
      const res = await fetch('/postulaciones', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
        body: JSON.stringify({ id_oferta: id })
      });
      const data = await res.json();
      alert(data.message || data.error);
      cargarOfertas();
    }

    function logout() {
      localStorage.clear();
      window.location.href = 'index.html';
    }

    cargarOfertas();
  </script>
</body>
</html>